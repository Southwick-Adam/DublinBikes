<div id="dublin_bike_map_id" class="h-screen w-screen"></div>
<script type="module">
	const importGoogleMapsLibraries = async () => {
		const {Map} = await google.maps.importLibrary('maps');
		const {AdvancedMarkerElement, PinElement} = await google.maps.importLibrary(
			'marker'
		);

		return {Map, AdvancedMarkerElement, PinElement};
	};

	const {Map, AdvancedMarkerElement, PinElement} =
		await importGoogleMapsLibraries();

	const mapSettings = {
		zoom: 14,
		center: {lat: 53.347, lng: -6.27},
		mapTypeControl: false,
		streetViewControl: false,
		ClickableIcons: false,
		mapId: 'dublin_bike_map_id',
	};

	const fetchProcessedStations = async () => {
		const response = await fetch('/stations'); // Assuming '/stations' is your Flask endpoint
		const stations = await response.json();
		return stations;
	};

	function createInfoWindow(station, content) {
		return new google.maps.InfoWindow({
			content: content,
			ariaLabel: `Bike Stand ${station.id.toString()}`,
		});
	}

	function createAdvancedMarker(map, pin, station) {
		return new AdvancedMarkerElement({
			map: map,
			position: {lat: station.lat, lng: station.lng},
			title: 'not selected',
			content: pin.element,
			gmpClickable: true,
		});
	}

	function createPin(station, pinColors) {
		const div = document.createElement('div');
		div.className = 'font-bold';
		div.style.fontSize = '14px';
		div.textContent = station.available_bikes.toString();

		return new PinElement({
			background: pinColors.background,
			borderColor: pinColors.border,
			glyphColor: pinColors.border,
			glyph: div,
		});
	}

	let stationDict = {};

	function selectPin(selectedMarker, selectedPin, selectedInfo) {
		if (selectedMarker.title != 'selected') {
			//unselect all other pins;
			for (let id in stationDict) {
				let pin = stationDict[id]['stationPin'];
				let marker = stationDict[id]['stationMarker'];
				let infoWindow = stationDict[id]['stationInfoWindow'];
				let tr_back = pin.background.slice(0, 18) + ', 0.4)';
				let tr_bord = pin.borderColor.slice(0, 18) + ', 0.4)';
				let tr_glyph = pin.borderColor.slice(0, 18) + ', 0.2)';
				pin.background = tr_back;
				pin.borderColor = tr_bord;
				pin.glyphColor = tr_glyph;
				pin.scale = 1;
				marker.zIndex = 1;
				marker.title = 'not selected';
				infoWindow.close();
			}
			let sel_back = selectedPin.background.slice(0, 18) + ', 1)';
			let sel_bord = selectedPin.borderColor.slice(0, 18) + ', 1)';
			selectedPin.background = sel_back;
			selectedPin.borderColor = sel_bord;
			selectedPin.glyphColor = sel_bord;
			selectedPin.scale = 1.3;
			selectedMarker.zIndex = 2;
			selectedMarker.title = 'selected';
            selectedInfo.open(map, selectedMarker);
		} else {
			//reshow all pins;
			for (let id in stationDict) {
				let pin = stationDict[id]['stationPin'];
				let marker = stationDict[id]['stationMarker'];
                let infoWindow = stationDict[id]['stationInfoWindow'];
				let back = pin.background.slice(0, 18) + ', 1)';
				let bord = pin.borderColor.slice(0, 18) + ', 1)';
				pin.background = back;
				pin.borderColor = bord;
				pin.glyphColor = bord;
				pin.scale = 1;
				marker.zIndex = 1;
				marker.title = 'not selected';
                infoWindow.close();
			}
		}
	}

	const mapElement = document.getElementById('dublin_bike_map_id');
	const map = new Map(mapElement, mapSettings);

	// Fetch and process the stations data
	fetchProcessedStations().then((stations) => {
		stations.forEach((station) => {
			console.log(station);
			// Assuming the Flask API returns pin colors and other necessary information
			const pin = createPin(station, station.pin_colors);
			const infoWindow = createInfoWindow(station, station.info_html);
			const marker = createAdvancedMarker(map, pin, station);
			marker.title = 'not selected';
			stationDict[station.id] = {
				stationMarker: marker,
				stationPin: pin,
				stationInfoWindow: infoWindow,
			};
			// Add the marker to the map
			marker.addListener('click', () => {
				selectPin(marker, pin, infoWindow);
			});
		});
	});
</script>
